<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Trip App – Login</title>
  <style>
    body{font-family:system-ui,Arial;background:#0f172a;color:#e5e7eb;margin:0;display:flex;align-items:center;justify-content:center;height:100vh}
    .card{background:#111827;border:1px solid #2d3748;padding:24px;border-radius:16px;max-width:360px;width:100%}
    h1{margin-top:0;font-size:22px;text-align:center}
    input,button{width:100%;padding:10px;margin-top:10px;border-radius:12px;font-size:14px}
    input{border:1px solid #374151;background:#0b1220;color:#e5e7eb}
    input:focus{outline:2px solid #3b82f6}
    button{border:none;background:#2563eb;color:#fff;cursor:pointer}
    button:disabled{opacity:.5;cursor:default}
    .msg{margin-top:10px;font-size:14px}
    .ok{color:#86efac}.err{color:#fecaca}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="card">
    <h1>Login</h1>

    <!-- Step 1: Email & OTP -->
    <div id="stepEmail">
      <input id="email" placeholder="Email" type="email" autocomplete="email"/>
      <button id="sendOtpBtn">Send OTP</button>
      <input id="otp" placeholder="Enter OTP" class="hidden" inputmode="numeric" autocomplete="one-time-code"/>
      <button id="verifyOtpBtn" class="hidden">Verify OTP</button>
    </div>

    <!-- Step 2: Profile (name + phone) -->
    <div id="stepProfile" class="hidden">
      <input id="name" placeholder="Full Name" autocomplete="name"/>
      <input id="phone" placeholder="Contact Number" type="tel" autocomplete="tel"/>
      <button id="saveProfileBtn">Save & Continue</button>
    </div>

    <div id="msg" class="msg"></div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    // ===== Firebase init =====
    const firebaseConfig = {
      apiKey: "AIzaSyB529yOEmk9sDDcUiD5tkyCRsmJpvOn66s",
      authDomain: "tripapp-27b4f.firebaseapp.com",
      projectId: "tripapp-27b4f",
      storageBucket: "tripapp-27b4f.firebasestorage.app",
      messagingSenderId: "796205117191",
      appId: "1:796205117191:web:30507cc680c3b630b51fa2"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Persist sessions across reload/close
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(console.error);

    // ===== OTP API URL =====
    const OTP_API = "https://script.google.com/macros/s/AKfycbxDNRfdy9Ux1pjLP3bIrUuiyamnXo4N2HTV9wuaczaFWUC5Ea9RygVlPBg9c0amL4LtFQ/exec";

    // ===== UI refs =====
    const emailEl = document.getElementById("email");
    const otpEl = document.getElementById("otp");
    const sendOtpBtn = document.getElementById("sendOtpBtn");
    const verifyOtpBtn = document.getElementById("verifyOtpBtn");
    const stepEmail = document.getElementById("stepEmail");

    const stepProfile = document.getElementById("stepProfile");
    const nameEl = document.getElementById("name");
    const phoneEl = document.getElementById("phone");
    const saveProfileBtn = document.getElementById("saveProfileBtn");

    const msgEl = document.getElementById("msg");

    // ===== Helpers =====
    function showMsg(t,isErr=false){ msgEl.textContent=t; msgEl.className="msg "+(isErr?"err":"ok"); }
    async function sha256Hex(txt){ const enc=new TextEncoder().encode(txt); const buf=await crypto.subtle.digest("SHA-256",enc); return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join(""); }

    // Generate a per-browser deviceId (for session tracking)
    function getDeviceId(){
      const key = "deviceId";
      let id = localStorage.getItem(key);
      if(!id){ id = crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2); localStorage.setItem(key,id); }
      return id;
    }
    const deviceId = getDeviceId();

    // ===== Auto-redirect if already signed-in with profile =====
    auth.onAuthStateChanged(async (u)=>{
      try{
        if(!u) return; // show login UI
        // See if this user linked to an emailHash and has a profile → go to trips
        const link = await db.collection("authLinks").doc(u.uid).get();
        if(link.exists && link.data().emailHash){
          const p = await db.collection("profiles").doc(link.data().emailHash).get();
          if(p.exists){
            // attach single-session watcher; then go
            await attachSingleSession(link.data().emailHash, u.uid);
            const next = new URLSearchParams(location.search).get("next") || "trips.html";
            location.href = next;
          }
        }
      }catch(e){ console.warn(e); }
    });

    // ===== OTP Flow (JSONP) =====
    sendOtpBtn.onclick = ()=>{
      const email = emailEl.value.trim();
      if(!email){ showMsg("Enter email", true); return; }
      showMsg("Sending OTP…");
      const script = document.createElement("script");
      script.src = `${OTP_API}?action=sendOtp&email=${encodeURIComponent(email)}&callback=onOtpSent`;
      document.body.appendChild(script);
    };
    window.onOtpSent = (res)=>{
      if(res.ok){
        showMsg("OTP sent to email.");
        otpEl.classList.remove("hidden");
        verifyOtpBtn.classList.remove("hidden");
      } else showMsg(res.message || "Failed to send OTP", true);
    };

    verifyOtpBtn.onclick = ()=>{
      const email = emailEl.value.trim();
      const otp = otpEl.value.trim();
      if(!email||!otp){ showMsg("Enter email + OTP", true); return; }
      showMsg("Verifying…");
      const script = document.createElement("script");
      script.src = `${OTP_API}?action=verifyOtp&email=${encodeURIComponent(email)}&otp=${encodeURIComponent(otp)}&callback=onOtpVerified`;
      document.body.appendChild(script);
    };

    // After OTP success → sign in anon → link auth → prefill profile → show profile step
    window.onOtpVerified = async (res)=>{
      try{
        if(!res.ok){ showMsg(res.message || "Invalid OTP", true); return; }
        const email = res.data.email.trim().toLowerCase();
        const emailHash = await sha256Hex(email);

        if(!auth.currentUser){ await auth.signInAnonymously(); }
        const uid = auth.currentUser.uid;

        await db.collection("authLinks").doc(uid).set({ emailHash });

        // Prefill profile if exists
        const profSnap = await db.collection("profiles").doc(emailHash).get();
        if(profSnap.exists){
          const p = profSnap.data();
          nameEl.value = p.name || "";
          phoneEl.value = p.phone || "";
        }

        // Show profile form
        stepEmail.classList.add("hidden");
        stepProfile.classList.remove("hidden");
        showMsg("OTP verified! Please complete profile.");
      }catch(e){
        console.error(e);
        showMsg(e.message || String(e), true);
      }
    };

    // ===== Save Profile + single-session claim + go to trips =====
    saveProfileBtn.onclick = async ()=>{
      try{
        const name = nameEl.value.trim();
        const phone = phoneEl.value.trim();
        const email = emailEl.value.trim().toLowerCase();
        if(!name || !phone){ showMsg("Enter name + phone", true); return; }

        const emailHash = await sha256Hex(email);
        // store profile
        await db.collection("profiles").doc(emailHash).set({ email, name, phone }, { merge:true });

        // claim single active session for this emailHash
        await attachSingleSession(emailHash, auth.currentUser.uid, true);

        showMsg("Profile saved!");
        const next = new URLSearchParams(location.search).get("next") || "trips.html";
        location.href = next;
      }catch(e){
        console.error(e);
        showMsg(e.message || String(e), true);
      }
    };

    // ===== Single active login per email =====
    // We use /sessions/{emailHash} with { uid, deviceId, updatedAt }.
    // - When this device claims it, others see change via onSnapshot and sign out.
    // - We also keep a small heartbeat so stale sessions show activity.
    let sessionUnsub = null;
    async function attachSingleSession(emailHash, uid, claimNow=false){
      const sessRef = db.collection("sessions").doc(emailHash);

      if (claimNow){
        // Claim / overwrite with my uid+device
        await sessRef.set({
          uid, deviceId,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }

      // Watch for someone else taking over
      if(sessionUnsub) sessionUnsub();
      sessionUnsub = sessRef.onSnapshot(snap=>{
        const d = snap.data();
        if(!d) return;
        if(d.uid && d.uid !== uid){
          // Another device/session claimed this email → sign out here
          alert("You have been signed out because your account was opened on another device.");
          auth.signOut().finally(()=> location.href = "index.html");
        }
      });

      // Heartbeat: update timestamp every ~30s so you can monitor actives if needed
      setInterval(()=>{
        sessRef.set({ uid, deviceId, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true })
          .catch(()=>{});
      }, 30000);
    }

    // Optional: on unload, you could clear the session if you want strict logout-on-close
    // window.addEventListener("beforeunload", ()=>{
    //   const u = auth.currentUser; if(!u) return;
    //   db.collection("authLinks").doc(u.uid).get().then(doc=>{
    //     const emailHash = doc.exists ? doc.data().emailHash : null;
    //     if(emailHash) db.collection("sessions").doc(emailHash).delete().catch(()=>{});
    //   });
    // });
  </script>
</body>
</html>
