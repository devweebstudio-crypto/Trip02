<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Trips</title>
  <style>
    body{font-family:system-ui,Arial;background:#0f172a;color:#e5e7eb;margin:0}
    header{padding:12px 16px;background:#111827;border-bottom:1px solid #2d3748;display:flex;justify-content:space-between;align-items:center}
    h1{margin:0;font-size:18px}
    button{padding:8px 12px;border-radius:8px;border:none;background:#2563eb;color:#fff;cursor:pointer;font-size:14px}
    button:disabled{opacity:.5;cursor:default}
    main{padding:16px}
    .card{background:#111827;border:1px solid #2d3748;padding:16px;border-radius:12px;margin-bottom:16px}
    input{padding:8px;width:100%;margin-top:8px;border-radius:8px;border:1px solid #374151;background:#0b1220;color:#e5e7eb}
    .trip{padding:12px;border:1px solid #2d3748;border-radius:10px;margin-bottom:8px;background:#1f2937;cursor:pointer}
    .trip:hover{background:#374151}
    .muted{color:#94a3b8;font-size:13px}
    .msg{margin-top:10px;font-size:14px}
    .ok{color:#86efac}.err{color:#fecaca}
    /* Modal */
    .modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center}
    .modal.hidden{display:none}
    .modal .box{background:#111827;padding:20px;border-radius:12px;max-width:400px;width:90%}
  </style>
</head>
<body>
  <header>
    <h1>Trips</h1>
    <button id="logoutBtn">Logout</button>
  </header>

  <main>
    <!-- Create Trip -->
    <div class="card">
      <h3>Create Trip</h3>
      <input id="tripName" placeholder="Trip Name"/>
      <button id="createTripBtn">Create</button>
    </div>

    <!-- Join Trip -->
    <div class="card">
      <h3>Join Trip</h3>
      <input id="joinCode" placeholder="Enter Code"/>
      <button id="joinTripBtn">Request to Join</button>
      <button id="scanQrBtn">Scan QR</button>
    </div>

    <!-- My Trips -->
    <div class="card">
      <h3>My Trips</h3>
      <div id="tripsList"></div>
    </div>

    <div id="msg" class="msg"></div>
  </main>

  <!-- Join Requests Modal -->
  <div id="requestsModal" class="modal hidden">
    <div class="box">
      <h3>Pending Join Requests</h3>
      <div id="requestsList"></div>
      <button id="closeRequests">Close</button>
    </div>
  </div>

  <!-- QR Scan Modal -->
  <div id="scanModal" class="modal hidden">
    <div class="box">
      <h3>Scan Trip QR</h3>
      <video id="qrVideo" autoplay style="width:100%"></video>
      <button id="closeScan">Close</button>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    // ===== Firebase =====
    const firebaseConfig = {
      apiKey: "AIzaSyB529yOEmk9sDDcUiD5tkyCRsmJpvOn66s",
      authDomain: "tripapp-27b4f.firebaseapp.com",
      projectId: "tripapp-27b4f",
      storageBucket: "tripapp-27b4f.firebasestorage.app",
      messagingSenderId: "796205117191",
      appId: "1:796205117191:web:30507cc680c3b630b51fa2"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ===== UI refs =====
    const tripNameEl = document.getElementById("tripName");
    const createTripBtn = document.getElementById("createTripBtn");
    const joinCodeEl = document.getElementById("joinCode");
    const joinTripBtn = document.getElementById("joinTripBtn");
    const scanQrBtn = document.getElementById("scanQrBtn");
    const tripsList = document.getElementById("tripsList");
    const msgEl = document.getElementById("msg");
    const logoutBtn = document.getElementById("logoutBtn");

    const requestsModal = document.getElementById("requestsModal");
    const requestsList = document.getElementById("requestsList");
    const closeRequests = document.getElementById("closeRequests");
    const scanModal = document.getElementById("scanModal");
    const closeScan = document.getElementById("closeScan");

    function showMsg(t,isErr=false){ msgEl.textContent=t; msgEl.className="msg "+(isErr?"err":"ok"); }

    // ===== Boot =====
    auth.onAuthStateChanged(async (u)=>{
      if(!u){ location.replace("index.html"); return; }
      // hide modals at start
      requestsModal.classList.add("hidden");
      scanModal.classList.add("hidden");
      loadTrips();
    });

    // ===== Trips =====
    async function loadTrips(){
      tripsList.innerHTML="";
      const me = auth.currentUser;
      const snap = await db.collectionGroup("members").where("uid","==",me.uid).get();
      if(snap.empty){ tripsList.textContent="No trips yet"; return; }
      for(const d of snap.docs){
        const tripId = d.ref.parent.parent.id;
        const t = await db.collection("trips").doc(tripId).get();
        if(!t.exists) continue;
        const el = document.createElement("div");
        el.className="trip";
        el.textContent = t.data().name+" ("+tripId+")";
        el.onclick=()=>{ location.href="map.html?tripId="+tripId; };
        tripsList.appendChild(el);
      }
    }

    // ===== Create Trip =====
    createTripBtn.onclick = async ()=>{
      const name = tripNameEl.value.trim();
      if(!name){ showMsg("Enter trip name",true); return; }
      try{
        const code = Math.random().toString(36).substr(2,6).toUpperCase();
        const codeHash = await sha256Hex(code);
        const me = auth.currentUser;
        const tripRef = db.collection("trips").doc();
        await tripRef.set({
          name, createdBy:me.uid, isActive:true,
          joinCodePlain:code, joinCodeHash:codeHash,
          memberUids:[me.uid], allowNewJoins:true,
          createdAt:firebase.firestore.FieldValue.serverTimestamp()
        });
        await tripRef.collection("members").doc(me.uid).set({
          uid:me.uid, role:"admin", displayName:"Me",
          shareEnabled:true, joinedAt:firebase.firestore.FieldValue.serverTimestamp(),
          createdBy:me.uid
        });
        await db.collection("joinCodes").doc(codeHash).set({ tripId:tripRef.id, isActive:true, allowNewJoins:true });
        showMsg("Trip created! Code: "+code);
        loadTrips();
      }catch(e){ showMsg("Error creating trip: "+e.message,true); }
    };

    // ===== Join Trip =====
    joinTripBtn.onclick = async ()=>{
      const code = joinCodeEl.value.trim();
      if(!code){ showMsg("Enter code",true); return; }
      const codeHash = await sha256Hex(code);
      try{
        const jc = await db.collection("joinCodes").doc(codeHash).get();
        if(!jc.exists){ showMsg("Invalid code",true); return; }
        const tripId = jc.data().tripId;
        const me = auth.currentUser;
        // create join request doc
        await db.collection("trips").doc(tripId).collection("joinRequests").doc(me.uid).set({
          uid:me.uid, displayName:"Me", createdAt:firebase.firestore.FieldValue.serverTimestamp()
        });
        showMsg("Request sent. Awaiting admin approval.");
      }catch(e){ showMsg("Error joining: "+e.message,true); }
    };

    // ===== Logout =====
    logoutBtn.onclick = ()=> auth.signOut();

    // ===== Helpers =====
    async function sha256Hex(txt){
      const enc=new TextEncoder().encode(txt);
      const buf=await crypto.subtle.digest("SHA-256",enc);
      return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
    }

    // ===== Close modals =====
    closeRequests.onclick = ()=> requestsModal.classList.add("hidden");
    closeScan.onclick = ()=> scanModal.classList.add("hidden");
  </script>
</body>
</html>
