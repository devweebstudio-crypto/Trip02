<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Trip Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <style>
    :root{--bg:#0f172a;--card:#111827;--muted:#94a3b8;--accent:#22c55e}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:var(--bg);color:#e5e7eb}
    header{padding:10px 12px;background:var(--card);display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(255,255,255,.06)}
    header .left{display:flex;align-items:center;gap:10px}
    header .trip{font-weight:700}
    header .code{font-size:12px;background:#0b1220;border:1px solid #25304a;padding:3px 8px;border-radius:8px}
    header .muted{color:var(--muted);font-size:12px}
    header .actions{display:flex;gap:8px;align-items:center}
    button{padding:8px 10px;border-radius:10px;border:1px solid #374151;background:#1f2937;color:#e5e7eb;cursor:pointer;font-size:14px}
    .btn.primary{background:var(--accent);color:#052e16;border:none}
    .btn.danger{background:#ef4444;color:#2f0b0b;border:none}
    main{height:calc(100vh - 52px);display:grid;grid-template-columns:1fr 320px}
    #map{width:100%;height:100%}
    aside{border-left:1px solid rgba(255,255,255,.06);background:#0b1220;display:flex;flex-direction:column}
    .panel{padding:12px;overflow:auto}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .switch{display:flex;align-items:center;gap:8px}
    .switch input{transform:scale(1.2)}
    .muted{color:var(--muted)}
    .member{padding:10px;border:1px solid #2d3748;border-radius:10px;margin-bottom:8px;background:#0b1020}
    .member .name{font-weight:700}
    .member .sub{font-size:12px;color:var(--muted)}
    .msg{font-size:13px;margin-top:8px;min-height:18px}
    .err{color:#fecaca}
    /* HUD bottom-left (mobile + desktop) */
    .hud{position:fixed;left:8px;bottom:8px;max-width:94vw;background:#0b1220;border:1px solid #243047;border-radius:12px;padding:8px 10px;z-index:5000}
    .hud h4{margin:0 0 6px 0;font-size:12px;color:#cbd5e1}
    .hud-list{display:flex;gap:8px;flex-wrap:wrap;max-height:32vh;overflow:auto}
    .chip{font-size:12px;border:1px solid #2b3b5a;border-radius:999px;padding:6px 8px;display:flex;gap:6px;align-items:center;background:#101a2f}
    .chip .dot{width:8px;height:8px;border-radius:50%}
    .chip a{color:#93c5fd;text-decoration:none}
    @media (max-width:900px){
      main{grid-template-columns:1fr}
      aside{display:none}
      .hud{max-height:44vh}
    }
  </style>
</head>
<body>
  <header>
    <div class="left">
      <button id="backBtn">← Back</button>
      <div>
        <div class="trip" id="tripName">Trip</div>
        <div class="muted"><span id="tripStatus">Active</span></div>
      </div>
      <div class="code" id="tripCode">CODE: —</div>
    </div>
    <div class="actions">
      <button id="destBtn" class="btn">Set destination</button>
      <div class="switch">
        <input type="checkbox" id="shareToggle"/>
        <label for="shareToggle">Share my location</label>
      </div>
      <button id="endTripBtn" class="btn danger" style="display:none">End Trip</button>
    </div>
  </header>

  <main>
    <div id="map"></div>
    <aside>
      <div class="panel">
        <div class="row"><div class="muted">Live members</div></div>
        <div id="membersList" style="margin-top:8px"></div>
        <div id="msg" class="msg"></div>
      </div>
    </aside>
  </main>

  <!-- HUD -->
  <div class="hud">
    <h4>Live members (distance from you)</h4>
    <div id="hudList" class="hud-list"></div>
  </div>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    // ===== Firebase =====
    const firebaseConfig = {
      apiKey: "AIzaSyB529yOEmk9sDDcUiD5tkyCRsmJpvOn66s",
      authDomain: "tripapp-27b4f.firebaseapp.com",
      projectId: "tripapp-27b4f",
      storageBucket: "tripapp-27b4f.firebasestorage.app",
      messagingSenderId: "796205117191",
      appId: "1:796205117191:web:30507cc680c3b630b51fa2"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ===== URL params =====
    const params = new URLSearchParams(location.search);
    const tripId = params.get("tripId");

    // ===== UI refs =====
    const backBtn = document.getElementById("backBtn");
    const tripNameEl = document.getElementById("tripName");
    const tripStatusEl = document.getElementById("tripStatus");
    const tripCodeEl = document.getElementById("tripCode");
    const destBtn = document.getElementById("destBtn");
    const shareToggle = document.getElementById("shareToggle");
    const endTripBtn = document.getElementById("endTripBtn");
    const membersList = document.getElementById("membersList");
    const msgEl = document.getElementById("msg");
    const hudList = document.getElementById("hudList");

    function setMsg(txt, isErr=false){ msgEl.textContent = txt; msgEl.className = "msg"+(isErr?" err":""); }

    // ===== Guard: require full login context =====
    let me=null, profile=null, isAdmin=false, isMember=false;
    async function ensureLoggedIn(){
      return new Promise((resolve)=>{
        auth.onAuthStateChanged(async (u)=>{
          if(!u){ location.replace("index.html?next="+encodeURIComponent(location.pathname+location.search)); return; }
          me = u;
          try{
            const link = await db.collection("authLinks").doc(u.uid).get();
            if(!link.exists || !link.data().emailHash){ location.replace("index.html?next="+encodeURIComponent(location.pathname+location.search)); return; }
            const prof = await db.collection("profiles").doc(link.data().emailHash).get();
            if(!prof.exists){ location.replace("index.html?next="+encodeURIComponent(location.pathname+location.search)); return; }
            profile = prof.data();
            resolve();
          }catch(e){ console.error(e); location.replace("index.html"); }
        });
      });
    }

    // ===== Map setup =====
    const map = L.map('map', { zoomControl:true });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(map);

    // My state
    let watchId = null;
    let myMarker = null;
    let myPolyline = L.polyline([], {opacity:0.95}).addTo(map);
    let lastTrackTs = 0;

    // Others
    const memberMarkers = new Map();   // uid -> marker
    const memberPolylines = new Map(); // uid -> polyline
    const memberInfo = new Map();      // uid -> {name, phone, lastSeen, lat, lng}

    // Destination
    let destMarker = null;
    let masterLine = null;

    function haversineKm(lat1,lng1,lat2,lng2){
      const R=6371, toRad=(d)=>d*Math.PI/180;
      const dLat=toRad(lat2-lat1), dLng=toRad(lng2-lng1);
      const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLng/2)**2;
      return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    }
    function formatAgo(ts){
      const s=Math.floor((Date.now()-ts)/1000);
      if(s<60) return s+"s ago";
      const m=Math.floor(s/60); if(m<60) return m+"m ago";
      const h=Math.floor(m/60); return h+"h ago";
    }

    function renderSideList(){
      const my = memberInfo.get(me.uid);
      membersList.innerHTML="";
      const entries = Array.from(memberInfo.entries()).sort((a,b)=> (a[1].name||"").localeCompare(b[1].name||""));
      for(const [uid,info] of entries){
        const isMe = uid===me.uid;
        let distTxt = "—";
        if (my && info.lat!=null && my.lat!=null){
          const d = haversineKm(my.lat, my.lng, info.lat, info.lng);
          distTxt = d<1 ? (d*1000).toFixed(0)+" m" : d.toFixed(2)+" km";
        }
        const phoneHtml = info.phone ? ` • <a href="tel:${info.phone}" style="color:#93c5fd;text-decoration:none">Call</a>` : "";
        const card = document.createElement("div");
        card.className="member";
        card.innerHTML = `
          <div class="name">${info.name||"Anon"} ${isMe?'<span class="muted">(you)</span>':''}</div>
          <div class="sub">${info.lat!=null?('Last seen '+formatAgo(info.lastSeen||Date.now())):'No signal'} • Distance: ${distTxt}${phoneHtml}</div>
        `;
        membersList.appendChild(card);
      }
    }
    function renderHud(){
      const my = memberInfo.get(me.uid);
      hudList.innerHTML="";
      const entries = Array.from(memberInfo.entries()).sort((a,b)=> (a[1].name||"").localeCompare(b[1].name||""));
      for(const [uid,info] of entries){
        let distTxt = "—";
        if (my && info.lat!=null && my.lat!=null){
          const d = haversineKm(my.lat, my.lng, info.lat, info.lng);
          distTxt = d<1 ? (d*1000).toFixed(0)+"m" : d.toFixed(2)+"km";
        }
        const chip = document.createElement("div");
        chip.className="chip";
        const dot = document.createElement("span");
        dot.className="dot";
        dot.style.background = uid===me.uid ? "#22c55e" : "#60a5fa";
        chip.appendChild(dot);
        const label = document.createElement("span");
        label.textContent = (info.name||"Anon")+" • "+distTxt;
        chip.appendChild(label);
        if(info.phone){
          const link = document.createElement("a");
          link.href = "tel:"+info.phone;
          link.textContent = "Call";
          chip.appendChild(link);
        }
        hudList.appendChild(chip);
      }
    }
    function renderLists(){ renderSideList(); renderHud(); }

    function upsertMemberMarker(uid, lat, lng, isMe=false){
      let m = memberMarkers.get(uid);
      if(!m){ m = L.marker([lat,lng]).addTo(map); memberMarkers.set(uid, m); }
      else { m.setLatLng([lat,lng]); }
      if(isMe){ myMarker = m; }
    }
    function upsertMemberPolyline(uid, pts){
      let pl = memberPolylines.get(uid);
      if(!pl){ pl = L.polyline(pts, {opacity: uid===me.uid? 1.0 : 0.6}).addTo(map); memberPolylines.set(uid, pl); }
      else { pl.setLatLngs(pts); }
    }

    // ===== Load trip & members (names + phone) =====
    let tripRef, isTripActive=true;
    async function loadTrip(){
      if(!tripId){ alert("Missing tripId"); location.replace("trips.html"); return; }
      tripRef = db.collection("trips").doc(tripId);
      const [tripSnap, memberSnap] = await Promise.all([ tripRef.get(), tripRef.collection("members").get() ]);
      if(!tripSnap.exists){ alert("Trip not found"); location.replace("trips.html"); return; }
      const t = tripSnap.data();
      tripNameEl.textContent = t.name || "Trip";
      tripStatusEl.textContent = t.isActive===false ? "Ended" : "Active";
      tripCodeEl.textContent = "CODE: " + (t.joinCodePlain || "—");
      isTripActive = t.isActive !== false;

      // membership/admin
      isMember = memberSnap.docs.some(d=> d.id===me.uid);
      if(!isMember){ alert("You are not a member of this trip"); location.replace("trips.html"); return; }
      const myDoc = memberSnap.docs.find(d=> d.id===me.uid);
      isAdmin = myDoc && myDoc.data().role === "admin";
      document.getElementById("endTripBtn").style.display = isAdmin ? "inline-block" : "none";
      document.getElementById("destBtn").style.display = isAdmin ? "inline-block" : "none";

      // seed names/phones
      for(const d of memberSnap.docs){
        const m = d.data();
        memberInfo.set(d.id, { name: m.displayName || "Anon", phone: m.phone || "", lastSeen: null, lat: null, lng: null });
      }

      // destination render if present
      if (t.destination && typeof t.destination.lat === "number" && typeof t.destination.lng === "number") {
        setDestinationOnMap(t.destination);
      }

      map.setView([20.5937, 78.9629], 5); // India fallback
    }

    // ===== Live positions listener =====
    function attachLiveListener(){
      return tripRef.collection("live").onSnapshot(snap=>{
        let toFit = [];
        snap.docChanges().forEach(ch=>{
          const uid = ch.doc.id;
          const data = ch.doc.data() || {};
          if(data.lat==null || data.lng==null) return;
          const info = memberInfo.get(uid) || { name:"Anon", phone:"" };
          info.lat = data.lat; info.lng = data.lng; info.lastSeen = data.ts || Date.now();
          memberInfo.set(uid, info);
          upsertMemberMarker(uid, data.lat, data.lng, uid===me.uid);
          toFit.push([data.lat, data.lng]);
        });
        renderLists();
        if(toFit.length && map.getZoom() < 6){
          const b = L.latLngBounds(toFit);
          map.fitBounds(b.pad(0.3));
        }
        updateMasterLine();
      }, err=>{
        console.error(err);
        setMsg("Live listener error: "+(err&&err.message||err), true);
      });
    }

    // ===== Tracks (recent) =====
    function dayKey(ts=Date.now()){
      const d=new Date(ts); const yyyy=d.getFullYear(); const mm=String(d.getMonth()+1).padStart(2,"0"); const dd=String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }
    async function loadRecentTracks(){
      const today = dayKey();
      const mSnap = await tripRef.collection("members").get();
      for(const m of mSnap.docs){
        const uid = m.id;
        const ptsSnap = await tripRef.collection("tracks").doc(uid).collection(today)
          .orderBy("ts","desc").limit(300).get();
        const pts = ptsSnap.docs.map(d=> d.data()).reverse().map(p=> [p.lat, p.lng]);
        if(pts.length){ upsertMemberPolyline(uid, pts); }
      }
    }

    // ===== Geolocation sharing =====
    function canGeo(){
      if (!("geolocation" in navigator)) { setMsg("Geolocation not supported", true); return false; }
      const isLocal = ["localhost","127.0.0.1","0.0.0.0"].includes(location.hostname);
      if (location.protocol !== "https:" && !isLocal) { setMsg("GPS needs HTTPS or http://localhost", true); return false; }
      if (!isTripActive) { setMsg("Trip is ended — sharing disabled", true); return false; }
      return true;
    }
    function startSharing(){
      if(!canGeo()) { shareToggle.checked=false; return; }
      setMsg("Sharing…");
      const opts = { enableHighAccuracy:true, maximumAge:0, timeout:20000 };
      const liveRef = tripRef.collection("live").doc(me.uid);
      const trackColl = tripRef.collection("tracks").doc(me.uid).collection(dayKey());

      // offline queue
      const qKey = `trackQueue:${tripId}:${me.uid}`;
      const flushQueue = async ()=>{
        try{
          const raw = localStorage.getItem(qKey); if(!raw) return;
          const arr = JSON.parse(raw)||[]; if(!arr.length) return;
          const batch = db.batch();
          for(const p of arr){ batch.set(trackColl.doc(), p); }
          await batch.commit();
          localStorage.removeItem(qKey);
        }catch(e){ console.warn("Flush queue failed", e); }
      };
      flushQueue();
      const flushTimer = setInterval(flushQueue, 5000);

      watchId = navigator.geolocation.watchPosition(async pos=>{
        const { latitude:lat, longitude:lng, speed, heading, accuracy } = pos.coords;
        const ts = Date.now();

        // write live
        try{
          await liveRef.set({ lat, lng, ts, speed: speed||0, heading: heading||0, accuracy: accuracy||0 }, { merge:true });
          setMsg("Location updated");
        }catch(e){
          console.error("live write failed", e);
          setMsg("Live write denied: "+(e && e.message || e), true);
        }

        // my visuals
        upsertMemberMarker(me.uid, lat, lng, true);
        const cur = myPolyline.getLatLngs(); cur.push([lat,lng]); if(cur.length>300) cur.shift(); myPolyline.setLatLngs(cur);
        const info = memberInfo.get(me.uid) || { name: profile?.name || "Me", phone: profile?.phone || "" };
        memberInfo.set(me.uid, { ...info, lat, lng, lastSeen: ts });
        renderLists();
        updateMasterLine();

        // ~1/sec track point
        if (ts - lastTrackTs >= 950){
          lastTrackTs = ts;
          const point = { lat, lng, ts };
          try{ await trackColl.doc().set(point); }
          catch(e){
            try{
              const arr = JSON.parse(localStorage.getItem(qKey)||"[]");
              arr.push(point);
              localStorage.setItem(qKey, JSON.stringify(arr));
            }catch(_){}
          }
        }

      }, err=>{
        console.error(err);
        setMsg("GPS error: "+(err && err.message || err), true);
      }, opts);

      shareToggle._stop = ()=>{
        if (watchId!=null){ navigator.geolocation.clearWatch(watchId); watchId=null; }
        clearInterval(flushTimer);
        setMsg("Sharing stopped");
      };
    }
    function stopSharing(){ if(shareToggle._stop){ shareToggle._stop(); shareToggle._stop=null; } }

    // ===== Destination (admin) =====
    function setDestinationOnMap(dest){
      if(destMarker){ map.removeLayer(destMarker); destMarker=null; }
      if(masterLine){ map.removeLayer(masterLine); masterLine=null; }
      destMarker = L.marker([dest.lat, dest.lng]).addTo(map).bindPopup("Destination: "+(dest.name||""));
      updateMasterLine();
    }
    function updateMasterLine(){
      if(!destMarker) return;
      const meInfo = memberInfo.get(me.uid);
      if(!meInfo || meInfo.lat==null) return;
      const to = destMarker.getLatLng();
      const from = L.latLng(meInfo.lat, meInfo.lng);
      if(masterLine){ masterLine.setLatLngs([from, to]); }
      else { masterLine = L.polyline([from, to], {opacity:0.7}).addTo(map); }
    }
    async function pickDestination(){
      if(!isAdmin){ alert("Only admins can set destination"); return; }
      alert("Click on the map to set destination point.");
      const once = (e)=>{
        map.off('click', once);
        const lat = e.latlng.lat, lng = e.latlng.lng;
        const name = prompt("Destination name?") || "Destination";
        const dest = { name, lat, lng };
        tripRef.update({ destination: dest })
          .then(()=>{ setDestinationOnMap(dest); setMsg("Destination set"); })
          .catch(err=> setMsg("Set destination failed: "+(err&&err.message||err), true));
      };
      map.on('click', once);
    }

    // ===== End trip (admin) =====
    async function endTrip(){
      if(!confirm("End this trip for everyone?")) return;
      try{
        await tripRef.update({ isActive:false, endedAt: firebase.firestore.FieldValue.serverTimestamp() });
        tripStatusEl.textContent = "Ended";
        endTripBtn.disabled = true;
        isTripActive = false;
        stopSharing();
        shareToggle.checked = false;
        setMsg("Trip ended");
      }catch(e){
        setMsg("End trip failed: "+(e&&e.message||e), true);
      }
    }

    // ===== Wire UI =====
    backBtn.onclick = ()=> history.length>1 ? history.back() : location.replace("trips.html");
    destBtn.onclick = pickDestination;
    shareToggle.addEventListener("change", ()=>{ if(shareToggle.checked) startSharing(); else stopSharing(); });
    endTripBtn.addEventListener("click", endTrip);

    // ===== Boot =====
    (async ()=>{
      if(!tripId){ alert("Missing tripId"); location.replace("trips.html"); return; }
      await ensureLoggedIn();
      await loadTrip();
      const unsubLive = attachLiveListener();
      await loadRecentTracks();
      // Center once on my current position (permission prompt)
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(p=>{
          map.setView([p.coords.latitude, p.coords.longitude], 14);
        }, ()=>{}, { enableHighAccuracy:true, maximumAge:10000, timeout:8000 });
      }
      window.addEventListener("beforeunload", ()=>{ stopSharing(); if(unsubLive) unsubLive(); });
    })();
  </script>
</body>
</html>
