<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Trip Map</title>
  <style>
    body,html{margin:0;padding:0;height:100%;font-family:sans-serif;background:#0f172a;color:#fff}
    #map{width:100%;height:100%}
    #sidebar{
      position:absolute;bottom:10px;left:10px;
      background:rgba(15,23,42,0.9);padding:10px;
      border-radius:8px;max-height:40%;overflow:auto;font-size:14px;width:250px;
    }
    .member{padding:6px;border-bottom:1px solid #334155;cursor:pointer}
    .member:last-child{border-bottom:none}
    .name{font-weight:600}
    .dist{font-size:12px;color:#94a3b8}
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="sidebar">
    <div id="tripName">Trip</div>
    <div id="members"></div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <!-- Google Maps -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDKQ9ObtOp348iAMvjoRPwjrHYcSD1wEPQ&libraries=geometry&callback=initMap"></script>

  <script>
    // === Firebase Config ===
    const firebaseConfig = {
      apiKey: "AIzaSyB529yOEmk9sDDcUiD5tkyCRsmJpvOn66s",
      authDomain: "tripapp-27b4f.firebaseapp.com",
      projectId: "tripapp-27b4f",
      storageBucket: "tripapp-27b4f.appspot.com",
      messagingSenderId: "796205117191",
      appId: "1:796205117191:web:30507cc680c3b630b51fa2"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const params = new URLSearchParams(location.search);
    const tripId = params.get("tripId");

    let map, me, isAdmin=false;
    const colors=["red","blue","green","orange","purple","cyan","yellow","pink"];
    const memberData=new Map(); // uid→{marker,polyline,color,info}

    // ====== Init Map ======
    function initMap(){
      map = new google.maps.Map(document.getElementById("map"), {
        center:{lat:20.5937,lng:78.9629}, zoom:5,
        mapTypeControl:false, streetViewControl:false, fullscreenControl:false
      });
      ensureLogin();
    }

    // ====== Auth ======
    function ensureLogin(){
      auth.onAuthStateChanged(async u=>{
        if(!u){ location.href="index.html"; return; }
        me=u;
        await loadTrip();
        attachLiveListener();
        startLocationUpdates();
      });
    }

    // ====== Load Trip ======
    async function loadTrip(){
      const tripDoc=await db.collection("trips").doc(tripId).get();
      if(!tripDoc.exists){ alert("Trip not found"); location.href="trips.html"; return; }
      document.getElementById("tripName").textContent=tripDoc.data().name;
      const mems=await db.collection("trips").doc(tripId).collection("members").get();
      if(!mems.docs.find(d=>d.id===me.uid)){ alert("Not a member"); location.href="trips.html"; return; }
      isAdmin= mems.docs.find(d=>d.id===me.uid).data().role==="admin";
      mems.forEach((d,i)=>{
        const data=d.data();
        memberData.set(d.id,{info:data,color:colors[i%colors.length]});
      });
      renderMembers();
    }

    // ====== Render Members Sidebar ======
    function renderMembers(){
      const el=document.getElementById("members");
      el.innerHTML="";
      const my=memberData.get(me.uid);
      memberData.forEach((m,uid)=>{
        const div=document.createElement("div");
        div.className="member";
        div.innerHTML=`<div class="name" style="color:${m.color}">${m.info.displayName||"Anon"} ${uid===me.uid?"(you)":""}</div>
          <div class="dist" id="dist-${uid}">—</div>`;
        div.onclick=()=>{ if(m.marker) map.panTo(m.marker.getPosition()); };
        el.appendChild(div);
      });
    }

    // ====== Attach Live Listener ======
    function attachLiveListener(){
      db.collection("trips").doc(tripId).collection("live")
        .onSnapshot(snap=>{
          snap.docChanges().forEach(ch=>{
            const uid=ch.doc.id;
            const d=ch.doc.data();
            if(!d.lat||!d.lng) return;
            let m=memberData.get(uid);
            if(!m) return;
            if(!m.marker){
              m.marker=new google.maps.Marker({
                position:{lat:d.lat,lng:d.lng},map:map,
                label:{text:m.info.displayName||"Anon",color:"#fff"},
                icon:{path:google.maps.SymbolPath.CIRCLE,scale:8,fillColor:m.color,fillOpacity:1,strokeColor:"#000",strokeWeight:1}
              });
              m.polyline=new google.maps.Polyline({path:[{lat:d.lat,lng:d.lng}],strokeColor:m.color,strokeOpacity:0.8,map:map});
            }else{
              m.marker.setPosition({lat:d.lat,lng:d.lng});
              const path=m.polyline.getPath(); path.push(new google.maps.LatLng(d.lat,d.lng));
            }
            m.last={lat:d.lat,lng:d.lng,ts:d.ts};
            memberData.set(uid,m);
          });
          updateDistances();
        });
    }

    // ====== Update Distances ======
    function updateDistances(){
      const my=memberData.get(me.uid);
      if(!my||!my.last) return;
      memberData.forEach((m,uid)=>{
        if(uid===me.uid||!m.last) return;
        const d=google.maps.geometry.spherical.computeDistanceBetween(
          new google.maps.LatLng(my.last.lat,my.last.lng),
          new google.maps.LatLng(m.last.lat,m.last.lng)
        );
        document.getElementById("dist-"+uid).textContent=(d<1000? d.toFixed(0)+" m":(d/1000).toFixed(2)+" km");
      });
    }

    // ====== Start location updates ======
    function startLocationUpdates(){
      if(!navigator.geolocation){ alert("Enable location"); return; }
      navigator.geolocation.watchPosition(async pos=>{
        const {latitude:lat,longitude:lng,speed,heading,accuracy}=pos.coords;
        const ts=Date.now();
        const liveRef=db.collection("trips").doc(tripId).collection("live").doc(me.uid);
        const trackRef=db.collection("trips").doc(tripId).collection("tracks").doc(me.uid).collection(new Date().toISOString().split("T")[0]);
        try{
          await liveRef.set({lat,lng,ts,speed,heading,accuracy},{merge:true});
          await trackRef.doc().set({lat,lng,ts});
        }catch(e){ console.error("Write failed",e); }
      }, err=>{
        alert("Location error: "+err.message);
      },{enableHighAccuracy:true,timeout:10000});
    }
  </script>
</body>
</html>
